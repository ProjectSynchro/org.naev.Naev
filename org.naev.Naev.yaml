id: org.naev.Naev
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: naev
rename-appdata-file: org.naev.Naev.metainfo.xml
finish-args:
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --share=ipc

modules:
  - name: python3-pyyaml
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "pyyaml" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/cd/e5/af35f7ea75cf72f2cd079c95ee16797de7cd71f29ea7c68ae5ce7be1eda0/PyYAML-6.0.1.tar.gz
        sha256: bfdf460b1736c775f2ba9f6a92bca30bc2095067b8a9d77876d1fad6cc3b4a43
        x-checker-data:
          type: pypi
          name: PyYAML
          packagetype: sdist

  - name: libunibreak
    no-autogen: false
    make-install-args:
      - PREFIX=/app
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: archive
        url: https://github.com/adah1972/libunibreak/releases/download/libunibreak_5_1/libunibreak-5.1.tar.gz
        sha512: c7762c0a5212a69de69fde7dcb3281e0d642a27da881337a6b0f71fac84fd097940dc92059d3daaf91dd21ae8b77d835432da058371958d0eb15af30077e2fba
        x-checker-data:
          type: json
          url: https://api.github.com/repos/adah1972/libunibreak/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name|endswith(".tar.gz")) | .browser_download_url

  - name: enet
    buildsystem: autotools
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: git
        url: https://github.com/lsalzman/enet.git
        tag: v1.3.17
        commit: e0e7045b7e056b454b5093cb34df49dc4cee0bee
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: script
        dest-filename: autogen.sh
        commands:
          - autoreconf -ifv

  - shared-modules/luajit/luajit.json
  - shared-modules/physfs/physfs.json

  - name: openblas
    no-autogen: true
    make-args:
      - DYNAMIC_ARCH=1
      - DYNAMIC_OLDER=1
      - FC=gfortran
      - TARGET=GENERIC
      - USE_OPENMP=0
    make-install-args:
      - PREFIX=/app
    cleanup:
      - /bin
      - /include
      - /lib/cmake
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: archive
        url: https://github.com/OpenMathLib/OpenBLAS/releases/download/v0.3.26/OpenBLAS-0.3.26.tar.gz
        sha512: 01d3a536fbfa62f276fd6b1ad0e218fb3d91f41545fc83ddc74979fa26372d8389f0baa20334badfe0adacd77bd944c50a47ac920577373fcc1d495553084373
        x-checker-data:
          type: json
          url: https://api.github.com/repos/OpenMathLib/OpenBLAS/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name|endswith(".tar.gz")) | .browser_download_url

  - name: suitesparse
    buildsystem: cmake
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DSUITESPARSE_ENABLE_PROJECTS=cholmod;cxsparse
    cleanup:
      - /bin
      - /include
      - /lib/cmake
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: git
        url: https://github.com/DrTimothyAldenDavis/SuiteSparse.git
        tag: v7.6.0
        commit: 1a4d4fb0c399b261f4ed11aa980c6bab754aefa6
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  - name: glpk
    no-autogen: false
    make-install-args:
      - PREFIX=/app
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: archive
        url: https://ftp.gnu.org/gnu/glpk/glpk-5.0.tar.gz
        sha512: 4e92195fa058c707146f2690f3a38b46c33add948c852f67659ca005a6aa980bbf97be96528b0f8391690facb880ac2126cd60198c6c175e7f3f06cca7e29f9d
        x-checker-data:
          type: anitya
          project-id: 1183
          stable-only: true
          url-template: https://ftp.gnu.org/gnu/glpk/glpk-$version.tar.gz

  - name: naev
    buildsystem: meson
    config-opts:
      - -Dbuildtype=release
      - -Db_lto=true
      - -Dauto_features=enabled
      - -Ddocs_c=disabled
      - -Ddocs_lua=disabled
    sources:
      - type: archive
        url: https://github.com/naev/naev/releases/download/nightly/naev-0.11.3%2B726.g209fbae06e-source.tar.xz
        sha512: 67ee47f9bea0ed5ca2769693ce28b75a643fe782b7cf94573a4a9608f9f57a2bc3d7229f0a33e1069e1b1a80a3e237bbf6f98cd909ca4300fc713002b1a4d2e4
        x-checker-data:
          type: json
          url: https://api.github.com/repos/naev/naev/releases/tags/nightly
          version-query: .tag_name
          url-query: .assets[] | select(.name|endswith("-source.tar.xz")) | .browser_download_url
      - type: patch
        path: metainfo.patch
      - type: patch
        path: disable_ascli.patch
      - type: patch
        path: disable_metainfo_test.patch
